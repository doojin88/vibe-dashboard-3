# User Flow Documentation
# 대학교 데이터 시각화 대시보드

**버전:** 1.0
**작성일:** 2025-11-02
**프로젝트명:** University Dashboard - Vibe Dashboard 2
**기반 문서:** PRD v1.0, Requirements Document

---

## 목차

1. [사용자 유형별 플로우](#1-사용자-유형별-플로우)
2. [인증 플로우](#2-인증-플로우)
3. [대시보드 조회 플로우](#3-대시보드-조회-플로우)
4. [데이터 관리 플로우](#4-데이터-관리-플로우)
5. [예외 상황 및 에러 핸들링](#5-예외-상황-및-에러-핸들링)
6. [페이지별 상세 플로우](#6-페이지별-상세-플로우)

---

## 1. 사용자 유형별 플로우

### 1.1 일반 이용자 (Viewer)

#### 주요 여정: 데이터 분석 및 조회

**입력:**
- 홈페이지 URL 접근
- Google 계정 정보 (로그인)
- 필터 선택 (연도, 단과대학, 학과 등)
- 네비게이션 메뉴 클릭

**처리:**
1. 홈페이지 랜딩 → 사이트 소개 및 로그인 버튼 표시
2. Google 로그인 버튼 클릭 → Clerk OAuth 프로세스 시작
3. Google 인증 완료 → 사용자 세션 생성 및 토큰 발급
4. 사용자 역할 확인 (Clerk Metadata 조회)
5. 메인 대시보드로 리다이렉트 (/dashboard)
6. 데이터베이스에서 최신 데이터 조회
7. KPI 집계 및 차트 데이터 생성
8. 사용자 필터 설정 적용 (URL 파라미터로 저장)
9. 필터된 데이터로 차트 재생성

**출력:**
- 메인 대시보드 화면 표시
- KPI 카드: 취업률, 논문 수, 연구비, 재학생 수
- 연도별 트렌드 차트
- 단과대학별 성과 비교 차트
- 필터링된 결과 실시간 업데이트
- 로딩 인디케이터 (데이터 로드 중)

**사이드 이펙트:**
- 사용자 세션 쿠키 저장 (7일 유효)
- 필터 설정 URL 파라미터 저장 (공유 가능)
- Google Analytics 이벤트 트래킹 (페이지뷰)
- 최근 조회 기록 로컬 스토리지 저장

**엣지 케이스:**
- Google 계정이 없는 경우: Google 계정 생성 안내 표시
- 첫 로그인 사용자: 온보딩 튜토리얼 표시 (스킵 가능)
- 네트워크 오류: 에러 메시지 및 재시도 버튼 표시
- 데이터 없는 경우: 빈 상태 UI 표시 및 안내 메시지
- 세션 만료: 자동으로 로그인 페이지로 리다이렉트

---

### 1.2 관리자 (Administrator)

#### 주요 여정: 데이터 업로드 및 검증

**입력:**
- 관리자 계정 로그인
- CSV/XLSX 파일 (드래그 앤 드롭 또는 파일 선택)
- 데이터 유형 선택 (학과KPI, 논문, 연구과제, 학생명단)
- 검증 결과 확인 및 승인/거부

**처리:**

**Step 1: 인증 및 권한 확인**
1. Google 로그인 완료
2. Clerk Metadata에서 사용자 role 조회
3. role이 'administrator'인지 검증
4. 권한 있는 경우: 데이터 관리 메뉴 표시
5. 권한 없는 경우: 403 에러 페이지 표시 및 접근 차단

**Step 2: 파일 업로드 (/data/upload)**
1. 파일 업로드 인터페이스 렌더링
2. 데이터 유형 선택 드롭다운 표시
3. 파일 선택 또는 드래그 앤 드롭 감지
4. 파일 형식 검증 (CSV, XLSX만 허용)
5. 파일 크기 검증 (최대 10MB)
6. 파일 매직 바이트 검증 (보안)
7. 파일을 Supabase Storage에 임시 업로드
8. 업로드 진행률 표시 (0-100%)
9. 업로드 완료 시 고유 file_id 생성

**Step 3: 데이터 검증 (/data/validation)**
1. 업로드된 파일 다운로드 및 파싱
2. CSV/XLSX 데이터를 JSON으로 변환
3. 스키마 검증 (Zod)
   - 필수 필드 존재 확인
   - 데이터 타입 검증 (Number, String, Date, Boolean)
   - 날짜 형식 검증 (YYYY-MM-DD)
   - 숫자 범위 검증 (음수, 이상값 체크)
4. 중복 데이터 검사
   - 고유 식별자 기준 (논문ID, 과제번호, 학번 등)
   - 중복 건수 및 레코드 목록 생성
5. 데이터 무결성 검증
   - 외래키 참조 무결성 (학과명, 단과대학명)
   - 논리적 일관성 (취업률 0-100%, 날짜 순서 등)
6. 검증 결과 리포트 생성
   - 총 레코드 수
   - 유효 레코드 수
   - 오류 레코드 수 및 상세 내역
   - 경고 레코드 수 (중복 등)
7. 데이터 미리보기 테이블 렌더링 (최대 100행)

**Step 4: DB 적재**
1. 관리자가 "적재 승인" 버튼 클릭
2. 트랜잭션 시작
3. 데이터 타입별 테이블 선택
   - department_kpi → kpi_metrics
   - publication_list → publications
   - research_project_data → research_projects, budget_executions
   - student_roster → students
4. Upsert 작업 수행 (중복 시 업데이트)
5. departments 테이블 자동 생성/업데이트 (단과대학, 학과)
6. 업로드 로그 기록 (upload_logs 테이블)
7. 트랜잭션 커밋
8. 임시 파일 삭제 (Supabase Storage)

**출력:**
- 파일 업로드 성공 메시지
- 검증 결과 리포트 화면
  - 총 레코드 수: 1,234건
  - 유효 레코드: 1,200건
  - 오류 레코드: 20건 (상세 내역 테이블)
  - 중복 레코드: 14건 (경고 표시)
- 데이터 미리보기 테이블 (페이지네이션)
- 적재 승인/거부 버튼
- 적재 완료 후 성공 토스트 메시지
- 자동으로 데이터 조회 페이지로 이동

**사이드 이펙트:**
- upload_logs 테이블에 이력 기록
  - file_name, file_type, file_size
  - data_type, status (success/failed)
  - rows_processed, error_message
  - uploaded_by (user_id), created_at
- Supabase Storage에 원본 파일 백업 (7일 보관)
- 관련 대시보드 캐시 무효화 (React Query)
- 관리자에게 이메일 알림 (성공/실패)

**엣지 케이스:**
- 파일 형식 불일치: 에러 메시지 표시 및 업로드 차단
- 파일 크기 초과: 에러 메시지 및 10MB 제한 안내
- 필수 필드 누락: 해당 행 번호 및 필드명 표시
- 데이터 타입 오류: 기대 타입 vs 실제 타입 표시
- 중복 데이터 발견: 경고 표시 및 선택 옵션 제공
  - 옵션 1: 중복 제외하고 적재
  - 옵션 2: 중복 데이터로 기존 데이터 덮어쓰기
  - 옵션 3: 업로드 취소
- 외래키 오류: 존재하지 않는 학과명 등 표시 및 수정 가이드
- DB 연결 오류: 재시도 버튼 및 시스템 관리자 문의 안내
- 트랜잭션 실패: 롤백 수행 및 원인 분석 메시지

---

### 1.3 교수진 (연구자)

#### 주요 여정: 개인 연구 성과 조회

**입력:**
- Google 로그인 (교수 계정)
- 본인 이름으로 필터링
- 연구자 성과 페이지 접근
- 논문 상세 정보 클릭

**처리:**
1. 로그인 완료 후 메인 대시보드 접근
2. 사이드바에서 "연구 성과 분석" → "연구자 성과" 클릭
3. /dashboard/research/researchers 페이지 로드
4. 사용자 프로필 정보에서 이름 추출 (Clerk User Metadata)
5. 자동으로 본인 이름 필터 적용
6. 연구책임자별 연구비 수주액 쿼리 실행
7. 연구책임자별 논문 수 집계
8. 과제연계 논문 비율 계산
9. 차트 및 테이블 렌더링

**출력:**
- 연구자 성과 대시보드
  - 총 연구비 수주액: 5억 2천만원 (KPI 카드)
  - 총 논문 수: 15편 (KPI 카드)
  - 과제연계 논문 비율: 60% (KPI 카드)
  - 연도별 연구비 추이 (라인 차트)
  - 지원기관별 연구비 분포 (파이 차트)
  - 논문 목록 테이블 (제목, 학술지, Impact Factor)
- 논문 상세 모달 (클릭 시)
  - 논문 제목
  - 주저자 및 참여저자
  - 학술지명 및 저널등급 (SCIE/KCI)
  - Impact Factor
  - 게재일
  - 과제연계 여부
- PDF 다운로드 버튼 (개인 성과 리포트)

**사이드 이펙트:**
- 사용자 조회 이력 기록 (analytics)
- 필터 설정 로컬 스토리지 저장
- 최근 조회한 논문 목록 저장

**엣지 케이스:**
- 데이터 없는 경우: 빈 상태 UI 및 안내 메시지
  - "아직 등록된 연구 성과가 없습니다."
  - "데이터 관리자에게 문의해주세요."
- 이름 불일치: 검색 결과 없음 안내 및 전체 데이터 표시
- 논문 상세 정보 없음: 기본 정보만 표시

---

## 2. 인증 플로우

### 2.1 Google 로그인 (Clerk OAuth)

**입력:**
- 홈페이지 또는 보호된 페이지 접근
- "Google로 로그인" 버튼 클릭

**처리:**

**Step 1: 로그인 시작**
1. 사용자가 비인증 상태에서 보호된 페이지 접근 시도
2. Clerk Middleware (`clerkMiddleware()`)가 요청 인터셉트
3. 사용자 세션 확인 (JWT 토큰)
4. 세션 없는 경우: 로그인 페이지로 리다이렉트
5. redirect_url 파라미터로 원래 페이지 URL 저장

**Step 2: Google OAuth**
1. Clerk `<SignInButton>` 컴포넌트 클릭
2. Clerk가 Google OAuth URL 생성
3. Google 로그인 페이지로 리다이렉트
4. 사용자가 Google 계정 선택 및 로그인
5. 권한 승인 화면 표시 (프로필, 이메일 접근)
6. 사용자가 "허용" 클릭

**Step 3: 인증 완료 및 콜백**
1. Google이 인증 코드 발급
2. Clerk Callback URL로 리다이렉트
3. Clerk가 인증 코드로 액세스 토큰 교환
4. Google API에서 사용자 프로필 정보 조회
   - email
   - name
   - profile_image_url
5. Clerk 내부에 사용자 계정 생성 (신규) 또는 로드 (기존)
6. JWT 세션 토큰 생성 및 쿠키 저장

**Step 4: 사용자 동기화 (Supabase)**
1. Clerk Webhook 또는 클라이언트에서 사용자 정보 전송
2. Supabase users 테이블 확인
3. clerk_user_id로 기존 사용자 검색
4. 신규 사용자인 경우:
   - users 테이블에 INSERT
   - role 기본값: 'viewer'
   - created_at: 현재 시각
5. 기존 사용자인 경우:
   - updated_at 갱신

**Step 5: 리다이렉트**
1. redirect_url 파라미터 확인
2. 값이 있는 경우: 원래 페이지로 리다이렉트
3. 값이 없는 경우: 메인 대시보드로 리다이렉트 (/dashboard)

**출력:**
- 로그인 성공 토스트 메시지
- 메인 대시보드 화면 표시
- Header에 사용자 아바타 및 이름 표시
- Sidebar 메뉴 활성화
- 사용자 역할에 따른 메뉴 표시
  - 관리자: 데이터 관리 메뉴 표시
  - 일반 사용자: 대시보드 메뉴만 표시

**사이드 이펙트:**
- JWT 토큰 쿠키 저장 (httpOnly, secure)
- Supabase users 테이블 업데이트
- 로그인 이벤트 로그 기록
- Google Analytics 이벤트 전송 (login)

**엣지 케이스:**
- Google 계정 없음: Google 계정 생성 페이지로 안내
- 권한 거부: 에러 메시지 표시 및 재시도 안내
- 네트워크 오류: 재시도 버튼 표시
- 중복 계정: 기존 계정과 병합 안내
- 이메일 미인증: 이메일 인증 요청 화면 표시
- OAuth 콜백 실패: 에러 로그 기록 및 재시도 안내

---

### 2.2 세션 관리

**입력:**
- 페이지 이동
- API 요청
- 일정 시간 경과

**처리:**

**세션 유지**
1. 매 페이지 요청 시 Middleware에서 JWT 토큰 검증
2. 토큰 유효기간 확인 (기본 7일)
3. 유효한 경우: 요청 통과 및 사용자 정보 주입
4. 토큰 만료 임박 시 (24시간 이내): 자동 갱신
5. Clerk가 새로운 JWT 발급 및 쿠키 갱신

**Remember Me**
1. 로그인 시 "로그인 유지" 체크박스 표시
2. 체크한 경우: 세션 유효기간 30일로 연장
3. 체크 안 한 경우: 기본 7일

**세션 만료**
1. JWT 토큰 유효기간 초과
2. Middleware에서 인증 실패 감지
3. 현재 페이지 URL 저장 (redirect_url)
4. 세션 쿠키 삭제
5. 로그인 페이지로 리다이렉트
6. "세션이 만료되었습니다" 메시지 표시

**출력:**
- 세션 유효: 정상 페이지 표시
- 세션 만료: 로그인 페이지 리다이렉트
- 자동 갱신: 사용자 인지 없이 백그라운드에서 처리

**사이드 이펙트:**
- JWT 토큰 쿠키 업데이트
- 세션 만료 이벤트 로그 기록

**엣지 케이스:**
- 토큰 변조 감지: 즉시 세션 무효화 및 로그아웃
- 동시 다중 디바이스 로그인: 각각 독립적인 세션 유지
- 탭 간 세션 동기화: BroadcastChannel API 사용

---

### 2.3 역할 기반 접근 제어 (RBAC)

**입력:**
- 보호된 페이지 접근 시도
- API 엔드포인트 호출

**처리:**

**권한 확인 - 클라이언트 사이드**
1. 페이지 컴포넌트 렌더링 전 권한 확인
2. Clerk `useUser()` 훅으로 사용자 정보 조회
3. publicMetadata.role 또는 Supabase users.role 조회
4. 필요 권한과 사용자 권한 비교
5. 권한 있는 경우: 페이지 렌더링
6. 권한 없는 경우: 403 페이지 리다이렉트

**권한 확인 - 서버 사이드**
1. API Route에서 `auth()` 함수 호출 (from '@clerk/nextjs/server')
2. 사용자 ID 추출
3. Supabase users 테이블에서 role 조회
4. 필요 권한 검증
5. 권한 있는 경우: API 로직 실행
6. 권한 없는 경우: 403 JSON 응답

**권한 레벨**
- **public**: 인증 불필요 (홈페이지)
- **authenticated**: 로그인만 필요 (대시보드)
- **administrator**: 관리자 전용 (데이터 관리)

**출력:**
- 권한 있음: 페이지/데이터 정상 표시
- 권한 없음: 403 에러 페이지
  - "접근 권한이 없습니다"
  - "관리자에게 문의하세요"
  - "대시보드로 돌아가기" 버튼

**사이드 이펙트:**
- 권한 없는 접근 시도 로그 기록
- 보안 이벤트 알림 (관리자)

**엣지 케이스:**
- role 정보 없음: 기본값 'viewer'로 처리
- role 불일치: Clerk와 Supabase 간 동기화 시도
- 권한 변경 후 캐시: 세션 갱신 또는 재로그인 요청

---

## 3. 대시보드 조회 플로우

### 3.1 메인 대시보드 (/dashboard)

**입력:**
- 로그인 후 자동 리다이렉트 또는 메뉴 클릭
- 필터 없음 (전체 데이터 표시)

**처리:**

**데이터 로딩**
1. 페이지 컴포넌트 마운트
2. React Query로 API 요청 (캐싱 활성화)
3. API Route에서 Supabase 쿼리 실행
   - KPI 메트릭 집계 (취업률, 논문 수, 연구비, 재학생 수)
   - 최신 평가년도 자동 선택
   - 전체 단과대학 데이터 조회
4. 집계 데이터 계산
   - 평균 취업률 (weighted average)
   - 총 논문 게재 수 (SCIE + KCI)
   - 총 연구비 수주액 (sum)
   - 총 재학생 수 (count)
5. 연도별 트렌드 데이터 생성 (최근 3년)
6. 단과대학별 성과 데이터 생성
7. JSON 응답 반환

**차트 렌더링**
1. API 응답 데이터 변환 (차트 라이브러리 형식)
2. KPI 카드 컴포넌트에 데이터 주입
3. 라인 차트 컴포넌트 렌더링 (연도별 트렌드)
4. 막대 그래프 컴포넌트 렌더링 (단과대학 비교)
5. 파이 차트 컴포넌트 렌더링 (연구비 분포)
6. 애니메이션 효과 적용

**출력:**
- 메인 대시보드 화면
- **KPI 카드 섹션** (상단)
  - 평균 취업률: 73.5%
  - 총 논문 게재 수: 1,234편
  - 총 연구비: 120억원
  - 재학생 수: 8,456명
- **연도별 트렌드** (중앙)
  - 취업률 추이 (라인 차트)
  - 기술이전 수입 추이 (막대 그래프)
  - 논문 게재 추이 (라인 차트)
- **단과대학별 성과 비교** (하단)
  - 단과대학별 취업률 (막대 그래프)
  - 단과대학별 연구비 (파이 차트)
- 로딩 스켈레톤 (데이터 로드 중)

**사이드 이펙트:**
- React Query 캐시에 데이터 저장 (5분 유효)
- 페이지뷰 이벤트 전송 (Google Analytics)

**엣지 케이스:**
- 데이터 없음: 빈 상태 UI 표시
- API 오류: 에러 메시지 및 재시도 버튼
- 네트워크 느림: 로딩 인디케이터 표시
- 부분 데이터: 사용 가능한 데이터만 표시 및 경고 메시지

---

### 3.2 학과별 KPI 대시보드 (/dashboard/department/kpi)

**입력:**
- 사이드바 메뉴 클릭: 학과 성과 관리 → 학과별 KPI
- 필터 선택:
  - 평가년도 (다중 선택 가능)
  - 단과대학 (다중 선택 가능)
  - 학과 (다중 선택 가능)

**처리:**

**초기 로딩**
1. 페이지 컴포넌트 마운트
2. 필터 옵션 데이터 로드
   - 사용 가능한 평가년도 목록 조회 (DISTINCT)
   - 단과대학 목록 조회
   - 학과 목록 조회 (단과대학 선택 시 필터링)
3. URL 파라미터에서 필터 값 읽기
4. 필터 값 없는 경우: 최신 년도 자동 선택

**필터 적용**
1. 사용자가 필터 변경 (드롭다운 선택)
2. URL 파라미터 업데이트
3. React Query 쿼리 키 변경 (자동 재fetch)
4. API 요청에 필터 파라미터 전달
5. Supabase WHERE 절에 필터 조건 적용
6. 필터링된 데이터 조회

**데이터 시각화**
1. 학과별 취업률 비교 (막대 그래프)
   - X축: 학과명
   - Y축: 취업률 (%)
   - 색상: 목표 대비 달성률 (green/yellow/red)
2. 교원 현황 (스택 바)
   - 전임교원 (blue)
   - 초빙교원 (green)
3. 기술이전 수입 Top 10 (순위 차트)
4. 국제학술대회 개최 현황 (히트맵)
   - X축: 학과
   - Y축: 년도
   - 색상: 개최 횟수

**출력:**
- 학과별 KPI 대시보드 화면
- 필터 섹션 (상단)
  - 평가년도: [2021, 2022, 2023] (다중 선택)
  - 단과대학: [공과대학, 경영대학, ...] (다중 선택)
  - 학과: [컴퓨터공학과, 기계공학과, ...] (다중 선택)
- KPI 요약 카드
  - 선택된 학과 수: 5개
  - 평균 취업률: 75.2%
  - 평균 전임교원 수: 12명
- 차트 섹션
  - 학과별 취업률 비교 (막대 그래프)
  - 교원 현황 (스택 바)
  - 기술이전 수입 Top 10
  - 국제학술대회 히트맵
- 데이터 테이블 (하단)
  - 페이지네이션 (50행/페이지)
  - 정렬 기능 (컬럼 클릭)
  - CSV 다운로드 버튼

**사이드 이펙트:**
- URL 파라미터 업데이트 (공유 가능)
- 필터 설정 로컬 스토리지 저장
- 차트 상호작용 이벤트 트래킹

**엣지 케이스:**
- 필터 선택 결과 데이터 없음: 빈 상태 UI 및 필터 초기화 버튼
- 잘못된 URL 파라미터: 기본값으로 리셋
- 다중 필터 충돌: 우선순위 적용 (년도 > 단과대학 > 학과)

---

### 3.3 논문 게재 현황 (/dashboard/research/publications)

**입력:**
- 사이드바 메뉴 클릭: 연구 성과 분석 → 논문 게재 현황
- 필터 선택:
  - 게재 연도 범위
  - 학과
  - 저널 등급 (SCIE, KCI)
  - 주저자 검색

**처리:**

**데이터 조회**
1. publications 테이블 조회
2. JOIN departments (단과대학, 학과 정보)
3. 필터 조건 적용 (WHERE)
4. 집계 쿼리 실행
   - 연도별 논문 수
   - 저널 등급별 분포
   - 학과별 논문 수
   - Impact Factor 통계 (평균, 최대, 최소)
5. 주저자별 논문 수 랭킹 (TOP 20)

**차트 생성**
1. 연도별 논문 게재 수 (라인 차트)
   - 다중 라인: SCIE, KCI 구분
2. 학술지 등급별 분포 (파이 차트)
3. 학과별 논문 게재 수 (막대 그래프)
4. Impact Factor 평균 추이 (라인 차트)
5. 주저자별 논문 수 랭킹 (데이터 테이블)

**논문 상세 모달**
1. 사용자가 논문 제목 클릭
2. 모달 컴포넌트 오픈
3. publication_id로 상세 정보 조회
4. 모달에 데이터 렌더링
   - 논문 제목
   - 주저자 및 참여저자 목록
   - 학술지명 및 저널등급
   - Impact Factor
   - 게재일
   - 과제연계 여부 (badge)
5. 모달 외부 클릭 또는 닫기 버튼으로 닫기

**출력:**
- 논문 게재 현황 화면
- 필터 섹션
- KPI 요약
  - 총 논문 수: 1,234편
  - SCIE: 678편, KCI: 556편
  - 평균 Impact Factor: 2.45
- 차트 섹션
  - 연도별 추이 (라인 차트)
  - 저널 등급별 분포 (파이 차트)
  - 학과별 비교 (막대 그래프)
  - Impact Factor 추이 (라인 차트)
- 주저자 랭킹 테이블
  - 순위, 이름, 소속 학과, 논문 수, 평균 IF
- 논문 상세 모달
- CSV 다운로드 버튼

**사이드 이펙트:**
- 필터 설정 URL 파라미터 저장
- 모달 오픈 이벤트 트래킹
- 다운로드 이벤트 트래킹

**엣지 케이스:**
- Impact Factor 없는 논문: "N/A" 표시
- 참여저자 없음: 주저자만 표시
- 주저자 검색 결과 없음: 빈 상태 UI
- 연도 범위 잘못 설정: 자동 수정 (시작 > 종료 시 swap)

---

### 3.4 연구과제 관리 (/dashboard/research/projects)

**입력:**
- 사이드바 메뉴 클릭: 연구 성과 분석 → 연구과제 관리
- 필터 선택:
  - 연구 연도
  - 지원기관
  - 학과
  - 진행 상태 (집행완료, 처리중)

**처리:**

**데이터 조회**
1. research_projects 테이블 조회
2. JOIN budget_executions (예산 집행 내역)
3. JOIN departments (학과 정보)
4. 필터 조건 적용
5. 집계 계산
   - 지원기관별 총 연구비
   - 학과별 총 연구비
   - 진행 상태별 과제 수
   - 예산 집행 추이 (월별)

**차트 생성**
1. 지원기관별 연구비 수주 현황 (파이 차트)
2. 학과별 총 연구비 (막대 그래프, 내림차순)
3. 과제별 진행 상태 (도넛 차트)
4. 연구비 집행 추이 (타임라인/라인 차트)

**과제 상세 테이블**
1. 페이지네이션 테이블 렌더링
2. 컬럼:
   - 과제번호
   - 과제명
   - 연구책임자
   - 소속학과
   - 지원기관
   - 총연구비
   - 집행금액
   - 집행률 (%)
   - 상태
3. 정렬 기능 (각 컬럼 클릭)
4. 검색 기능 (과제명, 연구책임자)

**출력:**
- 연구과제 관리 화면
- 필터 섹션
- KPI 요약
  - 총 과제 수: 234건
  - 총 연구비: 120억원
  - 집행률: 68.5%
- 차트 섹션
  - 지원기관별 분포 (파이 차트)
  - 학과별 연구비 (막대 그래프)
  - 진행 상태 (도넛 차트)
  - 집행 추이 (라인 차트)
- 과제 상세 테이블
- CSV/Excel 다운로드 버튼

**사이드 이펙트:**
- 필터 설정 저장
- 정렬/검색 상태 URL 파라미터 저장

**엣지 케이스:**
- 집행 데이터 없는 과제: 집행률 0% 표시
- 미래 날짜 집행일: 경고 아이콘 표시
- 집행금액 > 총연구비: 빨간색 경고 표시

---

## 4. 데이터 관리 플로우

### 4.1 CSV 파일 업로드 (/data/upload)

**입력:**
- 관리자 로그인
- 데이터 유형 선택 (드롭다운)
  - 학과KPI
  - 논문 게재 목록
  - 연구과제 데이터
  - 학생 명부
- CSV/XLSX 파일 (드래그 앤 드롭 또는 파일 선택)

**처리:**

**Step 1: 권한 확인**
1. Middleware에서 인증 상태 확인
2. 사용자 role 조회 (Clerk Metadata 또는 Supabase)
3. role !== 'administrator' 인 경우: 403 페이지 리다이렉트
4. role === 'administrator' 인 경우: 페이지 렌더링

**Step 2: 파일 선택**
1. 드래그 앤 드롭 영역 또는 파일 선택 버튼 표시
2. 사용자가 파일 선택
3. 파일 객체 읽기 (File API)
4. 클라이언트 사이드 검증
   - 파일 확장자: .csv, .xlsx만 허용
   - 파일 크기: 최대 10MB
   - MIME 타입: text/csv, application/vnd.ms-excel 등
5. 검증 실패 시: 에러 메시지 표시 및 업로드 차단
6. 검증 성공 시: 파일 미리보기 정보 표시
   - 파일명
   - 파일 크기 (MB)
   - 행 수 추정

**Step 3: 데이터 유형 매핑**
1. 사용자가 데이터 유형 선택
2. 선택된 유형에 따라 검증 스키마 결정
   - 학과KPI → department_kpi_schema
   - 논문 → publication_schema
   - 연구과제 → research_project_schema
   - 학생 → student_schema
3. 필수 컬럼 목록 표시 (참고용)

**Step 4: 파일 업로드**
1. "업로드" 버튼 클릭
2. FormData 생성 (file, data_type 포함)
3. POST /api/data/upload 요청
4. 업로드 진행률 표시 (XHR progress event)
5. 서버에서 파일 수신
6. 파일 매직 바이트 검증 (보안)
7. Supabase Storage에 임시 저장
   - 버킷: temp-uploads
   - 경로: {user_id}/{timestamp}_{filename}
8. 파일 메타데이터 저장 (upload_logs 테이블)
   - status: 'uploaded'
   - file_path: storage path
9. 고유 file_id 반환

**Step 5: 파싱 및 미리보기**
1. 업로드 성공 시 자동으로 /data/validation으로 리다이렉트
2. file_id URL 파라미터 전달

**출력:**
- 파일 업로드 성공 메시지
- 업로드 진행률 표시 (0-100%)
- 성공 시 자동 리다이렉트

**사이드 이펙트:**
- Supabase Storage에 파일 저장
- upload_logs 테이블 INSERT
- 업로드 이벤트 로그 기록

**엣지 케이스:**
- 파일 형식 불일치: "CSV 또는 XLSX 파일만 업로드 가능합니다" 에러
- 파일 크기 초과: "파일 크기는 10MB 이하여야 합니다" 에러
- 네트워크 오류: 재시도 버튼 표시
- 빈 파일: "파일에 데이터가 없습니다" 에러
- 권한 없음: 403 페이지 리다이렉트
- Storage 용량 초과: 에러 메시지 및 관리자 문의 안내

---

### 4.2 데이터 검증 (/data/validation)

**입력:**
- URL 파라미터: file_id
- 관리자 권한

**처리:**

**Step 1: 파일 로드**
1. file_id로 upload_logs 조회
2. file_path 추출
3. Supabase Storage에서 파일 다운로드
4. 파일 형식에 따라 파싱
   - CSV: Papa Parse 라이브러리 사용
   - XLSX: XLSX 라이브러리 사용
5. 데이터를 JSON 배열로 변환
6. 첫 100행 미리보기 데이터 추출

**Step 2: 스키마 검증**
1. data_type에 따라 Zod 스키마 선택
2. 각 행에 대해 스키마 검증 실행
3. 검증 결과 수집
   - valid_rows: 유효한 행
   - error_rows: 오류 행 (오류 메시지 포함)
   - warning_rows: 경고 행 (중복 등)

**필수 필드 검증**
```typescript
// 예: department_kpi_schema
const row = {
  평가년도: 2023,
  단과대학: "공과대학",
  학과: "컴퓨터공학과",
  졸업생취업률: 75.5,
  전임교원수: 15,
  초빙교원수: 3,
  기술이전수입: 5.2,
  국제학술대회: 2
}

// Zod 검증
schema.parse(row) // 성공 시 통과, 실패 시 에러
```

**데이터 타입 검증**
1. 숫자 필드: Number 타입 확인, NaN 체크
2. 날짜 필드: Date 형식 검증 (YYYY-MM-DD)
3. 문자열 필드: 길이 제한, 특수문자 검증
4. Boolean 필드: Y/N, true/false 변환

**Step 3: 비즈니스 로직 검증**
1. 논리적 일관성 체크
   - 취업률: 0-100 범위
   - 교원 수: 음수 불가
   - 날짜: 미래 날짜 경고
   - Impact Factor: 음수 불가
2. 외래키 참조 무결성
   - 단과대학명: departments 테이블 존재 확인
   - 학과명: departments 테이블 존재 확인
   - 존재하지 않는 경우: 자동 생성 제안 또는 에러

**Step 4: 중복 검사**
1. 고유 식별자 기준 중복 검사
   - 학과KPI: (평가년도, 단과대학, 학과)
   - 논문: (논문ID)
   - 연구과제: (과제번호, 집행ID)
   - 학생: (학번)
2. 기존 DB 데이터와 비교
3. 중복 발견 시:
   - 중복 레코드 목록 생성
   - 처리 옵션 제시
     - 중복 제외
     - 덮어쓰기 (UPDATE)
     - 병합 (MERGE)

**Step 5: 검증 리포트 생성**
1. 검증 결과 통계 계산
   - 총 레코드 수
   - 유효 레코드 수
   - 오류 레코드 수
   - 경고 레코드 수
   - 중복 레코드 수
2. 오류 상세 내역 테이블 생성
   - 행 번호
   - 필드명
   - 오류 메시지
   - 제안 수정 값

**Step 6: 미리보기 렌더링**
1. 데이터 테이블 렌더링 (최대 100행)
2. 오류 행 하이라이트 (빨간색)
3. 경고 행 하이라이트 (노란색)
4. 툴팁으로 오류/경고 메시지 표시

**출력:**
- 검증 결과 리포트
  ```
  검증 완료
  - 총 레코드: 1,234건
  - 유효: 1,200건 (97.2%)
  - 오류: 20건 (1.6%)
  - 경고: 14건 (1.1%) - 중복
  ```
- 오류 상세 테이블
  | 행 | 필드 | 오류 내용 | 값 |
  |----|------|----------|-----|
  | 5 | 취업률 | 범위 초과 (0-100) | 105 |
  | 12 | 게재일 | 잘못된 날짜 형식 | 2023/13/01 |
- 데이터 미리보기 테이블
  - 페이지네이션 (50행/페이지)
  - 오류/경고 행 하이라이트
- 중복 처리 옵션 (중복 발견 시)
  - [ ] 중복 데이터 제외하고 적재
  - [ ] 중복 데이터로 기존 데이터 덮어쓰기
- 액션 버튼
  - "적재 승인" (오류 없을 때만 활성화)
  - "수정 후 재업로드"
  - "취소"

**사이드 이펙트:**
- upload_logs.status 업데이트 ('validated')
- 검증 결과 메타데이터 저장 (JSON)

**엣지 케이스:**
- 파일 읽기 실패: 에러 메시지 및 재업로드 안내
- 전체 행 오류: "모든 데이터가 유효하지 않습니다" 경고
- 필수 컬럼 누락: "필수 컬럼이 누락되었습니다: [컬럼명]" 에러
- 인코딩 오류 (한글 깨짐): UTF-8 인코딩 안내
- 대용량 파일 (10,000행 이상): 배치 검증 (청킹)

---

### 4.3 DB 적재 (Commit)

**입력:**
- file_id
- 중복 처리 옵션 (선택 사항)
- "적재 승인" 버튼 클릭

**처리:**

**Step 1: 최종 확인**
1. 검증 상태 확인 (upload_logs.status === 'validated')
2. 오류 레코드 수 === 0 확인
3. 중복 처리 옵션 확인
4. 확인 모달 표시
   - "1,200건의 데이터를 적재하시겠습니까?"
   - "취소" / "확인" 버튼

**Step 2: 트랜잭션 시작**
1. Supabase Transaction 시작
2. 데이터 유형별 적재 로직 실행

**학과KPI 적재**
```sql
-- 1. departments 자동 생성/업데이트
INSERT INTO departments (college_name, department_name)
VALUES ('공과대학', '컴퓨터공학과')
ON CONFLICT (college_name, department_name) DO NOTHING;

-- 2. kpi_metrics Upsert
INSERT INTO kpi_metrics (
  department_id, evaluation_year, employment_rate,
  full_time_faculty, visiting_faculty,
  tech_transfer_income, intl_conference_count
)
VALUES (
  (SELECT id FROM departments WHERE college_name='공과대학' AND department_name='컴퓨터공학과'),
  2023, 75.5, 15, 3, 5.2, 2
)
ON CONFLICT (department_id, evaluation_year)
DO UPDATE SET
  employment_rate = EXCLUDED.employment_rate,
  -- ... 기타 필드
  updated_at = NOW();
```

**논문 적재**
```sql
-- 중복 처리 옵션에 따라
-- 옵션 1: 중복 제외
INSERT INTO publications (...)
VALUES (...)
ON CONFLICT (publication_id) DO NOTHING;

-- 옵션 2: 덮어쓰기
INSERT INTO publications (...)
VALUES (...)
ON CONFLICT (publication_id) DO UPDATE SET ...;
```

**연구과제 적재**
```sql
-- research_projects 먼저 적재
INSERT INTO research_projects (...)
VALUES (...)
ON CONFLICT (project_number) DO UPDATE SET ...;

-- budget_executions 적재 (FK 참조)
INSERT INTO budget_executions (...)
VALUES (...)
ON CONFLICT (execution_id) DO UPDATE SET ...;
```

**학생 적재**
```sql
INSERT INTO students (...)
VALUES (...)
ON CONFLICT (student_number) DO UPDATE SET ...;
```

**Step 3: 적재 모니터링**
1. 적재 진행률 표시 (배치 단위)
2. 각 배치 완료 시 진행률 업데이트
3. 에러 발생 시 즉시 롤백 준비

**Step 4: 트랜잭션 커밋**
1. 모든 적재 완료 확인
2. 트랜잭션 커밋
3. upload_logs 업데이트
   - status: 'completed'
   - rows_processed: 실제 적재된 행 수
   - completed_at: 완료 시각
4. 임시 파일 삭제 (Supabase Storage)
5. 관련 캐시 무효화 (React Query)

**Step 5: 적재 결과 통지**
1. 성공 토스트 메시지 표시
2. 적재 결과 요약 모달
   - 적재 완료: 1,200건
   - 소요 시간: 3.2초
   - "데이터 조회" 버튼
   - "대시보드 확인" 버튼

**출력:**
- 적재 성공 메시지
  ```
  데이터 적재 완료
  - 적재된 레코드: 1,200건
  - 소요 시간: 3.2초
  - 적재 완료 시각: 2025-11-02 14:35:22
  ```
- 적재 결과 모달
- 자동 리다이렉트: /data/browse?recent=true

**사이드 이펙트:**
- 데이터베이스 테이블 업데이트
- upload_logs.status = 'completed'
- Supabase Storage 임시 파일 삭제
- React Query 캐시 무효화
- 관리자 이메일 알림 (선택 사항)
- 적재 이벤트 로그 기록

**엣지 케이스:**
- DB 연결 오류: 롤백 및 재시도 안내
- 외래키 제약 위반: 에러 메시지 및 데이터 수정 안내
- 트랜잭션 타임아웃: 배치 크기 줄이기 제안
- 스토리지 용량 부족: 에러 메시지 및 공간 확보 안내
- 동시 적재 충돌: 락 감지 및 대기 안내

---

### 4.4 데이터 조회 (/data/browse)

**입력:**
- 관리자 로그인
- 데이터 테이블 선택 (드롭다운)
  - KPI 메트릭
  - 논문 게재
  - 연구과제
  - 예산 집행
  - 학생 정보
- 필터 조건:
  - 검색어 (텍스트)
  - 날짜 범위
  - 숫자 범위
- 정렬 조건 (컬럼, 방향)
- 페이지 번호

**처리:**

**Step 1: 테이블 선택**
1. 드롭다운에서 테이블 선택
2. 선택된 테이블 스키마 로드
3. 컬럼 정보 조회 (이름, 타입, 설명)
4. 필터 UI 동적 생성

**Step 2: 데이터 쿼리**
1. Supabase 쿼리 빌더 사용
2. 기본 SELECT 쿼리
3. WHERE 조건 추가 (필터)
4. ORDER BY 추가 (정렬)
5. LIMIT/OFFSET 추가 (페이지네이션)
6. COUNT 쿼리 (총 레코드 수)

**예시 쿼리 (논문 게재)**
```typescript
const { data, count } = await supabase
  .from('publications')
  .select('*, departments(college_name, department_name)', { count: 'exact' })
  .ilike('title', `%${searchTerm}%`) // 제목 검색
  .gte('publication_date', startDate) // 날짜 범위
  .lte('publication_date', endDate)
  .eq('journal_grade', 'SCIE') // 저널 등급
  .order('publication_date', { ascending: false })
  .range(offset, offset + limit - 1)
```

**Step 3: 테이블 렌더링**
1. 데이터 테이블 컴포넌트 렌더링
2. 컬럼 헤더 (정렬 아이콘 포함)
3. 데이터 행 렌더링
4. 페이지네이션 컨트롤
5. 행당 표시 개수 선택 (10, 25, 50, 100)

**Step 4: 상호작용**
1. 컬럼 헤더 클릭 → 정렬 토글 (ASC/DESC)
2. 검색어 입력 → 디바운스 후 쿼리 실행
3. 필터 변경 → 즉시 쿼리 실행
4. 페이지 변경 → 쿼리 실행
5. 행 클릭 → 상세 모달 표시

**Step 5: 데이터 다운로드**
1. "CSV 다운로드" 또는 "Excel 다운로드" 버튼 클릭
2. 현재 필터 조건으로 전체 데이터 쿼리
3. 데이터를 CSV/XLSX 형식으로 변환
4. Blob 생성 및 다운로드 트리거
5. 파일명: `{table_name}_{timestamp}.csv`

**출력:**
- 데이터 조회 화면
- 테이블 선택 드롭다운
- 필터 섹션
  - 검색어 입력
  - 날짜 범위 선택
  - 숫자 범위 입력
- 데이터 테이블
  - 컬럼 헤더 (정렬 가능)
  - 데이터 행 (50행/페이지)
  - 페이지네이션 컨트롤
  - 총 레코드 수 표시: "1,234건 중 1-50"
- 액션 버튼
  - CSV 다운로드
  - Excel 다운로드
  - 행 삭제 (선택 시)
- 상세 모달 (행 클릭 시)

**사이드 이펙트:**
- 필터/정렬 상태 URL 파라미터 저장
- 다운로드 이벤트 트래킹
- 삭제 이벤트 로그 기록

**엣지 케이스:**
- 검색 결과 없음: 빈 상태 UI 표시
- 다운로드 대용량 데이터: 진행률 표시 및 백그라운드 처리
- 삭제 권한 없음: 삭제 버튼 비활성화
- 페이지 범위 초과: 마지막 페이지로 리다이렉트

---

## 5. 예외 상황 및 에러 핸들링

### 5.1 인증 관련 에러

#### 5.1.1 로그인 실패

**시나리오:**
- Google OAuth 인증 실패
- 권한 거부
- 네트워크 오류

**처리:**
1. Clerk에서 에러 감지
2. 에러 타입 분류
   - `oauth_access_denied`: 사용자가 권한 거부
   - `network_error`: 네트워크 연결 문제
   - `invalid_credentials`: 인증 정보 오류
3. 에러 메시지 표시
4. 재시도 옵션 제공

**출력:**
- 에러 알림 모달
  ```
  로그인 실패
  Google 인증에 실패했습니다.
  [에러 원인]
  - "재시도" 버튼
  - "취소" 버튼
  ```

**사용자 액션:**
- 재시도 클릭 → 로그인 프로세스 재시작
- 취소 클릭 → 홈페이지로 이동

---

#### 5.1.2 세션 만료

**시나리오:**
- JWT 토큰 유효기간 초과
- 사용자가 장시간 비활성 상태

**처리:**
1. API 요청 시 401 Unauthorized 응답
2. Axios Interceptor에서 감지
3. 현재 페이지 URL 저장 (redirect_url)
4. 세션 쿠키 삭제
5. 로그인 페이지로 리다이렉트

**출력:**
- 토스트 메시지
  ```
  세션이 만료되었습니다
  다시 로그인해주세요.
  ```
- 로그인 페이지 리다이렉트

**사용자 액션:**
- 로그인 완료 → 원래 페이지로 자동 리다이렉트

---

#### 5.1.3 권한 없음 (403)

**시나리오:**
- 일반 사용자가 관리자 페이지 접근
- 역할 정보 불일치

**처리:**
1. Middleware 또는 페이지 컴포넌트에서 권한 확인
2. 권한 없음 감지
3. 403 에러 페이지 렌더링

**출력:**
- 403 에러 페이지
  ```
  접근 권한이 없습니다

  이 페이지는 관리자만 접근할 수 있습니다.
  관리자 권한이 필요한 경우 시스템 관리자에게 문의하세요.

  - "대시보드로 돌아가기" 버튼
  - "로그아웃" 버튼
  ```

**사용자 액션:**
- 대시보드로 돌아가기 → /dashboard 이동
- 로그아웃 → 홈페이지 이동

---

### 5.2 데이터 관련 에러

#### 5.2.1 파일 업로드 실패

**시나리오:**
- 파일 크기 초과 (>10MB)
- 잘못된 파일 형식
- 네트워크 오류
- Storage 용량 부족

**처리:**
1. 클라이언트 또는 서버에서 검증 실패 감지
2. 에러 타입 분류
3. 업로드 중단
4. 에러 메시지 표시

**출력:**
- 에러 메시지
  ```
  파일 업로드 실패

  [원인별 메시지]
  - 파일 크기 초과: "파일 크기는 10MB 이하여야 합니다. (현재: 15.3MB)"
  - 형식 오류: "CSV 또는 XLSX 파일만 업로드 가능합니다."
  - 네트워크 오류: "네트워크 연결을 확인해주세요."
  - Storage 부족: "저장 공간이 부족합니다. 관리자에게 문의하세요."

  - "다시 시도" 버튼
  - "취소" 버튼
  ```

**사용자 액션:**
- 파일 수정 후 재업로드
- 관리자 문의 (용량 부족 시)

---

#### 5.2.2 데이터 검증 실패

**시나리오:**
- 필수 필드 누락
- 데이터 타입 불일치
- 범위 초과 값
- 외래키 참조 오류

**처리:**
1. 검증 프로세스에서 오류 감지
2. 오류 레코드 및 상세 정보 수집
3. 검증 리포트 생성
4. 적재 버튼 비활성화

**출력:**
- 검증 실패 리포트
  ```
  검증 실패

  총 1,234건 중 20건의 오류가 발견되었습니다.
  오류를 수정한 후 다시 업로드해주세요.

  [오류 상세 테이블]
  행 | 필드 | 오류 내용 | 현재 값
  5  | 취업률 | 범위 초과 (0-100) | 105
  12 | 게재일 | 잘못된 날짜 형식 | 2023/13/01

  - "오류 데이터 다운로드" 버튼 (CSV)
  - "수정 후 재업로드" 버튼
  - "취소" 버튼
  ```

**사용자 액션:**
- 오류 데이터 다운로드 → CSV 파일로 저장
- 데이터 수정 후 재업로드

---

#### 5.2.3 DB 적재 실패

**시나리오:**
- 외래키 제약 위반
- 트랜잭션 타임아웃
- DB 연결 오류
- 중복 키 충돌

**처리:**
1. 트랜잭션 실행 중 에러 발생
2. 자동 롤백 실행
3. 에러 타입 분석
4. 에러 로그 기록
5. 에러 메시지 표시

**출력:**
- 에러 알림
  ```
  데이터 적재 실패

  [원인별 메시지]
  - 외래키 오류: "존재하지 않는 학과명이 포함되어 있습니다: [목록]"
  - 타임아웃: "처리 시간이 초과되었습니다. 데이터를 분할하여 업로드해주세요."
  - 연결 오류: "데이터베이스 연결에 실패했습니다. 잠시 후 다시 시도해주세요."

  - "재시도" 버튼
  - "관리자 문의" 버튼
  ```

**사용자 액션:**
- 재시도 (연결 오류 시)
- 데이터 수정 (외래키 오류 시)
- 관리자 문의 (복잡한 오류 시)

---

### 5.3 UI/UX 에러

#### 5.3.1 페이지 로딩 실패 (404)

**시나리오:**
- 존재하지 않는 페이지 접근
- 잘못된 URL

**처리:**
1. Next.js 라우팅에서 404 감지
2. 404 페이지 렌더링

**출력:**
- 404 에러 페이지
  ```
  페이지를 찾을 수 없습니다

  요청하신 페이지가 존재하지 않거나 이동되었습니다.
  URL을 확인하고 다시 시도해주세요.

  - "홈으로 가기" 버튼
  - "대시보드" 버튼
  - "뒤로 가기" 버튼
  ```

---

#### 5.3.2 데이터 로딩 실패

**시나리오:**
- API 요청 실패
- 네트워크 오류
- 타임아웃

**처리:**
1. React Query에서 에러 감지
2. 재시도 로직 실행 (최대 3회)
3. 재시도 실패 시 에러 UI 표시

**출력:**
- 에러 상태 UI
  ```
  [차트 영역에 표시]

  데이터 로딩 실패
  데이터를 불러오는 중 오류가 발생했습니다.

  - "다시 시도" 버튼
  ```

**사용자 액션:**
- 다시 시도 클릭 → API 재요청

---

#### 5.3.3 차트 렌더링 실패

**시나리오:**
- 차트 라이브러리 에러
- 데이터 형식 불일치
- 브라우저 호환성 문제

**처리:**
1. 차트 컴포넌트에서 try-catch
2. 에러 로그 기록 (Sentry)
3. Fallback UI 표시

**출력:**
- Fallback UI
  ```
  [차트 영역]

  차트를 표시할 수 없습니다
  데이터는 정상이지만 차트 렌더링에 실패했습니다.

  - "데이터 테이블로 보기" 버튼 (대체 뷰)
  - "문제 신고" 버튼
  ```

**사용자 액션:**
- 데이터 테이블로 보기 → 테이블 형식으로 데이터 표시
- 문제 신고 → 에러 리포트 전송

---

### 5.4 시스템 에러

#### 5.4.1 서버 에러 (500)

**시나리오:**
- 서버 내부 오류
- 예상치 못한 예외

**처리:**
1. API Route에서 예외 발생
2. Error Boundary에서 감지
3. 에러 로그 기록 (Sentry, Vercel Logs)
4. 500 에러 페이지 렌더링

**출력:**
- 500 에러 페이지
  ```
  서버 오류가 발생했습니다

  일시적인 문제가 발생했습니다.
  잠시 후 다시 시도해주세요.

  문제가 지속되면 관리자에게 문의하세요.
  에러 ID: ERR-20251102-143522-A1B2C3

  - "새로고침" 버튼
  - "관리자 문의" 버튼
  ```

**사용자 액션:**
- 새로고침 → 페이지 재로드
- 관리자 문의 → 에러 ID 포함하여 문의

---

#### 5.4.2 데이터베이스 연결 실패

**시나리오:**
- Supabase 다운타임
- 네트워크 파티셔닝
- 연결 풀 고갈

**처리:**
1. DB 쿼리 실패 감지
2. 재시도 로직 (exponential backoff)
3. 재시도 실패 시 에러 표시

**출력:**
- 에러 알림
  ```
  데이터베이스 연결 실패

  데이터베이스에 연결할 수 없습니다.
  네트워크 상태를 확인하거나 잠시 후 다시 시도해주세요.

  - "재시도" 버튼
  - "시스템 상태 확인" 링크
  ```

---

### 5.5 에러 복구 전략

#### 자동 재시도
- API 요청 실패 시 자동 재시도 (React Query)
- 지수 백오프 전략 (1초, 2초, 4초)
- 최대 재시도 횟수: 3회

#### 에러 로깅
- Sentry 통합 (프로덕션)
- Vercel Analytics 활용
- 에러 스택 트레이스 수집
- 사용자 컨텍스트 포함 (user_id, page, action)

#### 사용자 피드백
- 명확한 에러 메시지
- 해결 방법 안내
- 재시도 옵션 제공
- 관리자 문의 경로

#### Graceful Degradation
- 차트 실패 시 테이블 뷰 제공
- 부분 데이터 표시 (일부만 성공)
- 오프라인 상태 감지 및 안내

---

## 6. 페이지별 상세 플로우

### 6.1 홈페이지 (/)

**입력:**
- URL 직접 접근 또는 로고 클릭

**처리:**
1. 공개 페이지로 인증 불필요
2. 정적 콘텐츠 렌더링
3. 사용자 세션 확인
4. 로그인 상태에 따라 버튼 변경

**출력:**
- 비로그인 상태:
  - 사이트 소개 섹션
  - 주요 기능 안내
  - "Google로 로그인" 버튼
- 로그인 상태:
  - 사이트 소개 섹션
  - "대시보드로 이동" 버튼

**사용자 액션:**
- 로그인 버튼 클릭 → Google OAuth 시작
- 대시보드로 이동 → /dashboard 리다이렉트

---

### 6.2 예산 집행 현황 (/dashboard/budget/execution)

**입력:**
- 사이드바 메뉴 클릭: 예산 관리 → 예산 집행 현황
- 필터: 집행 연도, 학과, 집행항목, 상태

**처리:**
1. budget_executions 및 research_projects JOIN 쿼리
2. 집계 데이터 생성
   - 월별 집행금액
   - 집행항목별 비율
   - 학과별 집행금액
   - 상태별 통계
3. 차트 데이터 변환

**출력:**
- 예산 집행 현황 화면
- KPI 카드
  - 총 집행금액: 82억원
  - 집행률: 68.5%
  - 처리중 금액: 38억원
- 차트
  - 월별 집행금액 추이 (라인 차트)
  - 집행항목별 비율 (파이 차트)
    - 인건비: 45%
    - 장비비: 30%
    - 재료비: 15%
    - 기타: 10%
  - 학과별 집행금액 (막대 그래프)
- 집행 내역 테이블
  - 페이지네이션
  - 정렬 기능

---

### 6.3 학생 현황 (/dashboard/students/enrollment)

**입력:**
- 사이드바 메뉴 클릭: 학생 현황 → 재학생 현황
- 필터: 단과대학, 학과, 과정구분, 학적상태

**처리:**
1. students 테이블 조회
2. JOIN departments
3. 집계 쿼리
   - 단과대학별 재학생 수
   - 학과별 재학생 수
   - 과정구분별 분포
   - 학적상태별 분포
4. 차트 데이터 생성

**출력:**
- 재학생 현황 화면
- KPI 카드
  - 총 재학생: 8,456명
  - 학사: 6,234명
  - 석사: 1,567명
  - 박사: 655명
- 차트
  - 단과대학별 재학생 분포 (도넛 차트)
  - 학과별 재학생 수 (막대 그래프, Top 20)
  - 과정구분별 현황 (스택 바)
  - 학적상태별 현황 (파이 차트)
- 학생 목록 테이블
  - 학번, 이름, 학과, 학년, 과정구분
  - 검색 및 정렬 기능

---

### 6.4 지도교수별 현황 (/dashboard/students/advisors)

**입력:**
- 사이드바 메뉴 클릭: 학생 현황 → 지도교수별 현황
- 필터: 학과, 지도교수 검색

**처리:**
1. students 테이블 GROUP BY advisor
2. 통계 계산
   - 교수별 지도학생 수
   - 과정구분별 분포
   - 학과별 평균 지도학생 수
3. 데이터 정렬 (지도학생 수 내림차순)

**출력:**
- 지도교수별 현황 화면
- KPI 카드
  - 총 지도교수: 234명
  - 평균 지도학생: 6.2명
  - 최다 지도학생: 15명
- 차트
  - 교수별 지도학생 수 분포 (히스토그램)
  - 과정구분별 분포 (스택 바)
- 교수별 상세 테이블
  - 교수명, 학과, 지도학생 수, 학사/석사/박사 분포
  - 검색 및 정렬 기능
- 학생 목록 (교수 클릭 시 확장)

---

## 7. 주요 사용자 시나리오 종합

### 시나리오 1: 경영진의 월간 성과 리뷰

**목표:** 전체 대학의 월간 성과 파악 및 의사결정

**플로우:**
1. Google 로그인
2. 메인 대시보드 확인
   - 전체 KPI 한눈에 파악
   - 전월 대비 증감 확인
3. 학과별 KPI 대시보드 이동
   - 성과 저조 학과 식별
   - 필터로 특정 학과 상세 분석
4. 연구 성과 분석
   - 논문 게재 추이 확인
   - 연구비 수주 현황 파악
5. PDF 리포트 다운로드
6. 경영진 회의에서 활용

---

### 시나리오 2: 관리자의 분기별 데이터 업데이트

**목표:** 분기별 최신 데이터 업로드 및 검증

**플로우:**
1. Google 로그인 (관리자 계정)
2. 데이터 관리 → 파일 업로드
3. 데이터 유형 선택 (학과KPI)
4. CSV 파일 드래그 앤 드롭
5. 자동으로 검증 페이지 이동
6. 검증 리포트 확인
   - 오류 발견 시: 데이터 수정 후 재업로드
   - 오류 없을 시: 적재 승인
7. DB 적재 완료
8. 대시보드에서 업데이트 확인
9. 주요 이해관계자에게 업데이트 알림

---

### 시나리오 3: 교수의 개인 성과 조회

**목표:** 본인의 연구 성과 및 지도학생 확인

**플로우:**
1. Google 로그인 (교수 계정)
2. 연구 성과 분석 → 연구자 성과
3. 자동으로 본인 이름 필터 적용
4. 개인 성과 확인
   - 연구비 수주액
   - 논문 게재 수
   - 과제연계 논문 비율
5. 논문 게재 현황 이동
6. 주저자 필터로 본인 논문 검색
7. 논문 상세 정보 확인
8. 학생 현황 → 지도교수별 현황
9. 본인 지도학생 목록 확인
10. 개인 성과 리포트 PDF 다운로드

---

## 8. 공통 UI 패턴

### 8.1 로딩 상태

- **스켈레톤 로더**: 차트 및 테이블 영역
- **스피너**: 버튼 클릭 후 처리 중
- **프로그레스 바**: 파일 업로드, 데이터 적재

### 8.2 빈 상태 (Empty State)

- **아이콘 + 메시지**: 데이터 없음 안내
- **액션 버튼**: 데이터 추가 또는 필터 초기화

### 8.3 에러 상태

- **인라인 에러**: 폼 필드 아래 에러 메시지
- **토스트**: 일시적 알림 (3초 자동 닫힘)
- **모달**: 중요한 에러 및 확인 필요

### 8.4 성공 피드백

- **토스트**: 작업 완료 알림
- **체크 아이콘**: 성공 상태 표시
- **자동 리다이렉트**: 다음 단계로 이동

---

## 9. 접근성 고려사항

### 키보드 네비게이션
- Tab/Shift+Tab: 포커스 이동
- Enter/Space: 버튼 활성화
- Esc: 모달 닫기
- Arrow Keys: 차트 탐색

### 스크린 리더
- ARIA 레이블 적용
- 이미지 alt 텍스트
- 폼 필드 label 연결
- 차트 데이터 대체 텍스트

### 색상 대비
- WCAG 2.1 AA 준수
- 4.5:1 이상 명암비
- 색상만으로 정보 전달 금지 (아이콘 병행)

---

## 10. 성능 최적화

### 데이터 로딩
- React Query 캐싱 (5분)
- Prefetching (다음 페이지)
- 페이지네이션 (50행 단위)

### 차트 렌더링
- 가상화 (대용량 데이터)
- 디바운싱 (필터 변경)
- 메모이제이션 (차트 컴포넌트)

### 파일 업로드
- 청크 업로드 (대용량)
- 압축 (gzip)
- 백그라운드 처리 (워커)

---

**문서 종료**

이 Userflow 문서는 PRD를 기반으로 모든 사용자 시나리오와 상호작용을 상세히 정의합니다.
각 플로우는 실제 구현 시 참고할 수 있도록 입력/처리/출력/사이드이펙트/엣지케이스를 명확히 구분하였습니다.
